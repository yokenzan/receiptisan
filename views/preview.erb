<% @receipts.each do | receipt | %>

    <!-- HEADER SECTION -->
    <div id="receipt-section-<%= receipt.id %>">
        <table class="receipt-header-table">
            <tbody>
                <tr>
                    <th><% if receipt.id.zero? %>‰∏çÊòé<% else %>No.<%= receipt.id %><% end %></th>
                    <td>
                        <%= receipt.shinryo_ym.to_s.sub('-', '.') %><% if receipt.shinryo_ym %>Ë®∫ÁôÇ<% end %>
                        &emsp;
                        <%= receipt.seikyu_ym.to_s.sub('-', '.')  %><% if receipt.seikyu_ym  %>Ë´ãÊ±Ç<% end %>
                    </td>
                </tr>
                <tr>
                    <th>Á®ÆÂà•</td>
                    <td>
                        <% receipt.type.to_details.each do | (type_code, type_name) | %>
                            <span class="receipt-type-badge"><%= type_code %> <%= type_name %></span>
                        <% end %>
                    </td>
                </tr>
                <tr>
                    <th>ÁâπË®ò‰∫ãÈ†Ö</td>
                    <td>
                        <% receipt.tokki_jikos.each do | tokki_jiko | %>
                            <span class="receipt-tokki-jiko-badge"><%= tokki_jiko %></span>
                        <% end %>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- PATIENT SECTION -->
    <% patient = receipt.patient %>
    <div class="patient-info-table">
        <table>
            <tbody>
                <tr>
                    <th>ÊÇ£ËÄÖÁï™Âè∑</th>
                    <td><%= patient.id %></td>
                </tr>
                <tr>
                    <th>ÊÇ£ËÄÖÊ∞èÂêç</th>
                    <td>
                        <%= @util.mask_name(patient.name) %>
                        <% if patient.name_kana %>&nbsp; (<%= @util.mask_name(patient.name_kana) %>)<% end %>
                    </td>
                <tr>
                    <th>ÁîüÂπ¥ÊúàÊó•</th>
                    <% if patient.aged? && receipt.shinryo_ym %>
                        <td>
                            <%= patient.birthday.strftime('%Y.%m.%d') %>Áîü
                             &nbsp; (<%= patient.age_of(receipt.shinryo_ym) %>Ê≠≥<%= patient.age_month_of(receipt.shinryo_ym) %>„ÅãÊúà)
                             <%= { '1': 'Áî∑‚ôÇÔ∏è', '2': 'Â•≥‚ôÄÔ∏è' }[patient.sex.to_s.intern] %>
                        </td>
                    <% end %>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- HOKEN SECTION -->
    <div class="hoken-info-table">
        <table>
            <thead>
                <tr>
                    <th>‰øùÈô∫</th>
                    <th>‰∫ãÊ•≠ËÄÖÁï™Âè∑</th>
                    <th>ÂÆüÊó•Êï∞</th>
                    <th>Ë´ãÊ±ÇÁÇπÊï∞</th>
                    <th>Ë≤†ÊãÖÈáë</th>
                </tr>
            </thead>
            <tbody>
                <% kohi_count = 0 %>
                <% receipt.hokens.each_with_index do | hoken, idx | %>
                    <tr>
                    <% if hoken.is_a?(Recediff::Iho) %>
                        <% iho = hoken %>
                        <td>ÂåªÁôÇ‰øùÈô∫</td>
                        <td class="number-style"><%= @util.mask_bango(iho.hokenja_bango) %></td>
                        <td class="number-style"><%= iho.day_count %>Êó•</td>
                        <td class="number-style"><%= @util.int2money(iho.point) %>ÁÇπ</td>
                        <td class="number-style">
                            <%= futankin = @util.int2money(iho.futankin) %>
                            <% unless futankin.empty? %>ÂÜÜ<% else %>-<% end %>
                        </td>
                    <% elsif hoken.is_a?(Recediff::Kohi) %>
                        <% kohi = hoken %>
                        <% kohi_count += 1 %>
                        <td>ÂÖ¨Ë≤ª<%= kohi_count %></td>
                        <td class="number-style"><%= @util.mask_bango(kohi.futansha_bango) %></td>
                        <td class="number-style"><%= kohi.day_count %>Êó•</td>
                        <td class="number-style"><%= @util.int2money(kohi.point) %>ÁÇπ</td>
                        <td class="number-style">
                            <%= futankin = @util.int2money(kohi.futankin) %>
                            <% unless futankin.empty? %>ÂÜÜ<% end %>

                            <% parened_futankin = receipt.nyuin? ? kohi.nyuin_futankin : kohi.gairai_futankin %>
                            <% unless parened_futankin.nil? %>
                                &nbsp; (<% @util.int2money(parened_futankin) %>ÂÜÜ)
                            <% end %>
                        </td>
                    <% end %>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>

    <!-- DISEASE SECTION -->

    <% diseases = receipt.diseases %>
    <% unless diseases.empty? %>
        <div class="disease-table">
            <table>
                <thead>
                    <th>#</th>
                    <th>‰∏ªÁóÖ</th>
                    <th>ÂÇ∑ÁóÖÂêç</th>
                    <th>ÈñãÂßãÊó•</th>
                    <th>Ëª¢Â∏∞</th>
                </thead>
                <tbody>
                    <% diseases.each_with_index do | disease, idx | %>
                        <% is_main      = disease.main? %>
                        <% disease_name = disease.name %>
                        <tr class="<% if is_main %>disease-main<% end %> <% if disease.worpro? %>worpro<% end %>">
                            <td><%= idx + 1 %></td>
                            <td><% if is_main %><span class="disease-main-badge">&nbsp;‰∏ª&nbsp;</span><% else %>&emsp;<% end %></td>
                            <% if disease_name.length > 30 %>
                                <td title="<%= disease_name %>"><%= disease_name.sub(/^(\S{30}).*/, '\\1...') %></td>
                            <% elsif disease_name.empty? %>
                                <td title="ÂÇ∑ÁóÖÂêç„Ç≥„Éº„Éâ : <%= disease.code %>" class="disease-fail-display">(üö´Ë°®Á§∫„Åß„Åç„Åæ„Åõ„Çì)</td>
                            <% else %>
                                <td><%= disease_name %></td>
                            <% end %>
                            <td><%= disease.start_date.strftime('%Y.%m.%d') %></td>
                            <td>
                                <span class="disease-tenki-badge disease-tenki-badge-<%= disease.tenki_code %>">
                                    <%= disease.tenki %>
                                </span>
                            </td>
                        </tr>
                    <% end %>
                </tbody>
            </table>
        </div>
    <% end %>

    <!-- CONTENT SECTION -->

    <% calc_units = receipt.units %>
    <% shinryo_ym = receipt.shinryo_ym %>
    <% unless calc_units.empty? %>
        <% current_shinku = nil %>
        <div class="content-table">
            <table>
                <thead>
                    <tr>
                        <th>Ë®∫Âå∫</th>
                        <th>Ôºä</th>
                        <th>ÊòéÁ¥∞</th>
                        <th>ÁÇπÊï∞</th>
                        <th>ÂõûÊï∞</th>
                        <% shinryo_ym.dates.each do | date | %>
                            <th class="day-cell <%if date.wday == 0 %>day-sunday<% elsif date.wday == 6 %>day-saturday<% end %>"><%= %w(Êó• Êúà ÁÅ´ Ê∞¥ Êú® Èáë Âúü)[date.wday] %><br/><%= date.day %></th>
                        <% end %>
                    </tr>
                </thead>
                <tbody>
                    <% calc_units.each_with_index do | unit, unit_idx | %>
                        <% unit.each_with_index do | cost, cost_idx | %>
                        <% next_shinku    = unit.shinku != current_shinku %>
                        <% upper_shinku   = unit.shinku.to_s[0] != current_shinku.to_s[0] %>
                        <% new_unit       = cost_idx.zero? %>
                        <% current_shinku = unit.shinku %>
                        <tr class="
                            <% if upper_shinku %>
                                <% unless unit_idx.zero? %>row-upper-shinku<% end %>
                            <% elsif next_shinku %>
                                row-next-shinku
                            <% elsif new_unit %>
                                row-new-unit
                            <% end %>">
                            <td class="number-style"><% if next_shinku %><%= unit.shinku %><% end %></td>
                            <td class="column-asterisk"><% if cost_idx.zero? %><img style="height: 1em; width: 1em;" src="https://cdn.icon-icons.com/icons2/2248/PNG/512/asterisk_icon_135921.png"/><% end %></td>
                            <% category      = cost.category.intern %>
                            <% category_name = { SI: 'shinryo-koi', IY: 'iyakuhin', TO: 'tokutei-kizai', CO: 'comment' }[category] %>
                            <td class="column-cost-name <% if category == :CO && cost.code.to_i == 810000001 %>worpro<% end %> cost-<%= category_name %>">
                                <%= { SI: 'üí™', IY: 'üíä', TO: 'üî©', CO: 'üìë' }[category] %>
                                <% if category == :CO %>
                                    <% comment = cost %>
                                    <%= comment.text %>
                                    <% if additional_text = comment.additional_text %>
                                        <span class="worpro"><%= additional_text %></span>
                                    <% end %>
                                <% else %>
                                    <%= cost.name %>
                                    <% if cost.amount? %>
                                        <%= cost.amount_is_int? ? @util.int2money(cost.amount) : cost.amount.to_f.to_s %>
                                    <% end %>
                                <% end %>
                            </td>
                            <% if unit.length == cost_idx + 1 %>
                                <td class="number-style"><%= @util.int2money(unit.point) %></td>
                                <td class="number-style">√ó<%= unit.count %></td>
                                <% shinryo_ym.dates.each do | date | %><td class="day-cell number-style <%if date.wday == 0 %>day-sunday<% elsif date.wday == 6 %>day-saturday<% end %>"><%= unit.count_at(date.day).to_s.sub(/^0$/, '') %></td><% end %>
                            <% else %>
                                <td class="number-style"></td>
                                <td class="number-style"></td>
                                <% shinryo_ym.dates.each do | date | %><td class="day-cell number-style <%if date.wday == 0 %>day-sunday<% elsif date.wday == 6 %>day-saturday<% end %>"></td><% end %>
                            <% end %>
                        </tr>
                        <% end %>
                    <% end %>
                </tbody>
            </table>
        </div>
    <% end %>

    <hr class="receipt-separator" />
<% end %>
